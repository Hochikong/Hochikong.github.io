<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HOCHIKONG&#39;s WAPORIZer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="Be Lazy,Be VAPOR">
<meta property="og:type" content="website">
<meta property="og:title" content="HOCHIKONG&#39;s WAPORIZer">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="HOCHIKONG&#39;s WAPORIZer">
<meta property="og:description" content="Be Lazy,Be VAPOR">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HOCHIKONG&#39;s WAPORIZer">
<meta name="twitter:description" content="Be Lazy,Be VAPOR">
  
    <link rel="alternate" href="/atom.xml" title="HOCHIKONG&#39;s WAPORIZer" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/vapor3.jpg">
  <link rel="apple-touch-icon" href="/css/images/vapor3.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/home.css" >
  

  

  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

</head>



  <body>


  
    <header id="header">

	<!-- 背景图模式 -->
	

    
      <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">

      <!-- Support rolling -->  
        
        <section class="awSlider">
          <div class="carousel slide carousel-fade " data-ride="carousel">

            <!-- Wrapper for slides -->
            <div class="carousel-inner">
               
                  
                    <div class="item active">
                  
                    <img id="carousel-img0" src="/css/images/vaporwave-city-skyline.png">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img0 = new Image();
                      var imageTag0 = document.getElementById("carousel-img0");
                      img0.src = imageTag0.src;
                      img0.onload=function(){
                        if (img0.width / img0.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag0.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag0.style.height = document.body.clientHeight + "px";
                          imageTag0.style.marginLeft = -(document.body.clientHeight * img0.width / img0.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img1" src="/css/images/vapor1.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img1 = new Image();
                      var imageTag1 = document.getElementById("carousel-img1");
                      img1.src = imageTag1.src;
                      img1.onload=function(){
                        if (img1.width / img1.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag1.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag1.style.height = document.body.clientHeight + "px";
                          imageTag1.style.marginLeft = -(document.body.clientHeight * img1.width / img1.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img2" src="/css/images/vapor5.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img2 = new Image();
                      var imageTag2 = document.getElementById("carousel-img2");
                      img2.src = imageTag2.src;
                      img2.onload=function(){
                        if (img2.width / img2.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag2.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag2.style.height = document.body.clientHeight + "px";
                          imageTag2.style.marginLeft = -(document.body.clientHeight * img2.width / img2.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img3" src="/css/images/vapor4.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img3 = new Image();
                      var imageTag3 = document.getElementById("carousel-img3");
                      img3.src = imageTag3.src;
                      img3.onload=function(){
                        if (img3.width / img3.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag3.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag3.style.height = document.body.clientHeight + "px";
                          imageTag3.style.marginLeft = -(document.body.clientHeight * img3.width / img3.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
            </div>

            <!-- Controls -->
            <a class="left carousel-control" href=".carousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Geri</span>
            </a>
            <a class="right carousel-control" href=".carousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">İleri</span>
            </a>
          </div>
        </section>
        <script>
          $('section.awSlider .carousel').carousel({
              pause: '',
              interval: 5000
          });
          var startImage = $('section.awSlider .item.active > img').attr('src');
          $('section.awSlider .carousel').on('slid.bs.carousel', function () {
              var bscn = $(this).find('.item.active > img').attr('src');
              $('section.awSlider > img').attr('src', bscn);
          });
        </script>
      

    
 


    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      <!-- 折线Polyline背景 -->
      
		 function redraw(){
		 	var pattern = Trianglify({
				width: window.innerWidth,
				height: window.innerHeight
			});
            pattern.canvas(c)
        }
        document.getElementById("intrologo").onclick = redraw
        document.getElementById("intrologo").ontouchstart = redraw
		redraw()
      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">HOCHIKONG&#39;s WAPORIZer</a></h1>
            <h3>Be Lazy,Be VAPOR</h3>
            <h5>Hochikong</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- 自适应主页背景大图 -->
  

 <!-- home_logo_image居中 -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">首页</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">归档</a>
        
          <a id="beautifont" class="main-nav-link" href="/categories">分类</a>
        
          <a id="beautifont" class="main-nav-link" href="/tags">标签</a>
        
          <a id="beautifont" class="main-nav-link" href="/about">关于</a>
        
          <a id="beautifont" class="main-nav-link" href="https://ckho.top">Service</a>
        
          <a id="beautifont" class="main-nav-link" href="http://h2q.weebly.com">Works</a>
        
      </p>
  </div>

</header>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-pyqt5essential"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/03/03/pyqt5essential/">浅谈开发PyQt5应用的实践</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/03/03/pyqt5essential/" class="article-date">
	  <time datetime="2019-03-02T17:40:34.000Z" itemprop="datePublished">2019-03-03</time>
	</a>

      
    <a class="article-category-link" href="/categories/随笔/">随笔</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>其实在此之前我早就有接触过PyQt4，但是无奈接触的教程实在不够完整，也没有一条线索能循序渐进地学习，因此才放弃了PyQt，转而使用Electron开发GUI应用（学习Electron的路径实在太好了，有个很详细的例子可以参考）。直至到2019年2月某一天偶然发现packt的一门PyQt5视频教程限免，我就领取了并尝试看，然后就再次正式学习PyQt5。<a href="https://www.packtpub.com/application-development/python-gui-programming-recipes-using-pyqt5-video" target="_blank" rel="external">课程地址</a></p>
<h2 id="开发PyQt应用的核心"><a href="#开发PyQt应用的核心" class="headerlink" title="开发PyQt应用的核心"></a>开发PyQt应用的核心</h2><p>在接下来的内容里，我将会谈及几个在开发PyQt应用时重点关注的几个要点，部分内容引用自前面所述课程和我的<a href="https://github.com/Hochikong/Qtlearn" target="_blank" rel="external">github repo</a>，一个很简陋的记事本。我所使用的Python版本是Python 3.6.6</p>
<h3 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h3><p>开发一个复杂的PyQt应用必然不应该完全手写GUI部分的代码，无论是调整还是其他的改动都不太方便（如果真的纯手写我直接用Tkinter不就行了吗）。因此用Qt Designer进行UI设计是最好的，Qt Designer需要手动安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install pyqt5-tools</div></pre></td></tr></table></figure>
<p>安装完毕后在你的python安装目录里找到这个路径：~\Python36\Lib\site-packages\pyqt5_tools，并运行designer.exe即可打开。但关于如何使用Qt Designer不是本文的要点。</p>
<ol>
<li>在启动Qt Designer后就可以进行UI设计，设计完毕保存为.ui文件，实际上这个是xml结构的文件，可以通过pyuic进行转换，转换为python代码。</li>
<li>把UI转换为python代码后就可以另开一个文件，请参考我前面提到的记事本demo中的main.py，这个是我编写的程序的入口，经过pyuic自动生成的python文件作为程序的UI渲染器，而我所写的逻辑代码则放在main.py中，实现解耦。如果我们把逻辑混在自动生成的代码里，那么一旦需要在UI的设计上做微调，经过pyuic再次转换的话就会丢失前面所写的内容，因此解耦是很重要的一环。</li>
<li>完成逻辑编写、测试，就可以使用auto-py-to-exe进行Windows平台可执行文件的打包。</li>
</ol>
<h3 id="关键知识点"><a href="#关键知识点" class="headerlink" title="关键知识点"></a>关键知识点</h3><h4 id="Signal-amp-Slot"><a href="#Signal-amp-Slot" class="headerlink" title="Signal &amp; Slot"></a>Signal &amp; Slot</h4><p>这个可谓Qt的核心，如果有接触过jQuery，你就会发现这玩意其实和jQuery的事件处理机制差不多。这里贴一段jQuery的代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/jquery/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">onclicked</span>(<span class="params"></span>) </span>&#123;</span></div><div class="line"><span class="javascript">            $(<span class="string">"p"</span>).slideToggle();</span></div><div class="line"><span class="undefined">        &#125;</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="javascript">        $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></div><div class="line"><span class="javascript">            $(<span class="string">"button"</span>).click(onclicked);</span></div><div class="line"><span class="undefined">        &#125;);</span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>切换<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我再贴一段PyQt自动生成的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.actionExit.triggered.connect(MainWindow.close)</div></pre></td></tr></table></figure>
<p>可以看到两个代码具有相同的模式：选定对象，检测信号，根据提供的函数名调用函数。</p>
<p>在Qt里，actionExit是sender，被按下的时候就会emit一个triggered signal，使用connect到槽，PyQt这里的槽可以是python函数或者QObject的成员方法。同时你也应该注意到，两个代码都是提供了函数名作为click和connect的参数，若connect的参数是MainWindow.close()，那不用说都会报错。但笔者并不打算在此详细介绍signal &amp; slot，请有需要深入了解的读者自行查阅相关资料。</p>
<h4 id="QThread"><a href="#QThread" class="headerlink" title="QThread"></a>QThread</h4><p>如果程序需要执行长时间的任务并且任务与Widgets有交互的话，最好是使用QThread来实现，举个例子，执行一个爬虫并且需要在界面上展示爬取结果的话，就需要使用QThread创建新的线程，然后使用该线程执行相关代码，而如果不用多线程的话，就会阻塞GUI线程直到任务完成，期间用户无法操作GUI，而且Windows可能会提示程序无响应。</p>
<p>所以我们应该继承自QThread然后创建一个类，然后实现run方法，run方法的内容就是我们程序里的耗时任务。</p>
<p>这里引用一个网上的非常straight-forward的<a href="https://kushaldas.in/posts/pyqt5-thread-example.html" target="_blank" rel="external">例子</a>，情看下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python3</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> tempfile</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets</div><div class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QThread, pyqtSignal</div><div class="line"></div><div class="line"><span class="keyword">from</span> mainwindow <span class="keyword">import</span> Ui_MainWindow</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloneThread</span><span class="params">(QThread)</span>:</span></div><div class="line">    signal = pyqtSignal(<span class="string">'PyQt_PyObject'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        QThread.__init__(self)</div><div class="line">        self.git_url = <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment"># run method gets called when we start the thread</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        tmpdir = tempfile.mkdtemp()</div><div class="line">        cmd = <span class="string">"git clone &#123;0&#125; &#123;1&#125;"</span>.format(self.git_url, tmpdir)</div><div class="line">        subprocess.check_output(cmd.split())</div><div class="line">        <span class="comment"># git clone done, now inform the main thread with the output</span></div><div class="line">        self.signal.emit(tmpdir)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleApp</span><span class="params">(QtWidgets.QMainWindow, Ui_MainWindow)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, parent=None)</span>:</span></div><div class="line">        super(ExampleApp, self).__init__(parent)</div><div class="line">        self.setupUi(self)</div><div class="line">        self.pushButton.setText(<span class="string">"Git clone with Thread"</span>)</div><div class="line">        <span class="comment"># Here we are telling to call git_clone method when</span></div><div class="line">        <span class="comment"># someone clicks on the pushButton.</span></div><div class="line">        self.pushButton.clicked.connect(self.git_clone)</div><div class="line">        self.git_thread = CloneThread()  <span class="comment"># This is the thread object</span></div><div class="line">        <span class="comment"># Connect the signal from the thread to the finished method</span></div><div class="line">        self.git_thread.signal.connect(self.finished)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">git_clone</span><span class="params">(self)</span>:</span></div><div class="line">        self.git_thread.git_url = self.lineEdit.text()  <span class="comment"># Get the git URL</span></div><div class="line">        self.pushButton.setEnabled(<span class="keyword">False</span>)  <span class="comment"># Disables the pushButton</span></div><div class="line">        self.textEdit.setText(<span class="string">"Started git clone operation."</span>)  <span class="comment"># Updates the UI</span></div><div class="line">        self.git_thread.start()  <span class="comment"># Finally starts the thread</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finished</span><span class="params">(self, result)</span>:</span></div><div class="line">        self.textEdit.setText(<span class="string">"Cloned at &#123;0&#125;"</span>.format(result))  <span class="comment"># Show the output to the user</span></div><div class="line">        self.pushButton.setEnabled(<span class="keyword">True</span>)  <span class="comment"># Enable the pushButton</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    app = QtWidgets.QApplication(sys.argv)</div><div class="line">    form = ExampleApp()</div><div class="line">    form.show()</div><div class="line">    app.exec_()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>这个代码的耗时任务是git clone，因此作者继承自QThread并实现了run方法，这里引用Qt官方文档对run()的描述：</p>
<blockquote>
<p>void QThread::run()</p>
<p>The starting point for the thread. After calling <a href="https://doc.qt.io/qt-5/qthread.html#start" target="_blank" rel="external">start</a>(), the newly created thread calls this function. The default implementation simply calls <a href="https://doc.qt.io/qt-5/qthread.html#exec" target="_blank" rel="external">exec</a>().</p>
<p>You can reimplement this function to facilitate advanced thread management. Returning from this method will end the execution of the thread.</p>
<p><strong>See also</strong> <a href="https://doc.qt.io/qt-5/qthread.html#start" target="_blank" rel="external">start</a>() and <a href="https://doc.qt.io/qt-5/qthread.html#wait" target="_blank" rel="external">wait</a>().</p>
</blockquote>
<p>同时run的结尾有个emit，当任务执行完毕后将会发送一个信号，并把结果发送出去。</p>
<p>然后看ExampleApp的代码，实例化CloneThread后，把self.git_clone()和clicked事件连接起来，当按钮被clicked之后，就会通过新的线程执行git clone（调用CloneThread实例的start()方法），然后任务完毕把CloneThread实例发出的信号connect到self.finished()上，并作为run()所emit的内容作为finished()的参数执行收尾工作。</p>
<p>最后我们总结一下使用QThread的流程：</p>
<p>1.继承自QThread创建一个类，实现run方法，根据情况选择emit。</p>
<p>2.在GUI上监听事件，实例化步骤一的类，调用start()方法。</p>
<p>3.根据情况选择connect。</p>
<h4 id="GUI代码与逻辑代码的解耦"><a href="#GUI代码与逻辑代码的解耦" class="headerlink" title="GUI代码与逻辑代码的解耦"></a>GUI代码与逻辑代码的解耦</h4><p>在“核心流程”一节已经简单介绍过解耦的重要性，这里简单谈谈如何实践和需要关注的问题。首要的步骤是通过Qt Designer设计出你想要的UI，并可以借助style sheet来美化UI，然后把设计导出为.ui文件。设计是非常重要的工作，因此为了减少以后因为UI更改导致已经写好的逻辑代码出问题，我非常建议在用Designer开发UI前就做好设计，禁止在写逻辑代码的阶段再对UI做大幅度修改。</p>
<p>这里补充个坑：而在开发UI阶段要注意objectName字段，比如Designer里创建的默认窗体的菜单栏，如果你删掉了之前写的menuFile子项，你再创建同名子项的话，objectName字段里得到是自动加了后缀（删掉xxx，再创建就会出现xxx_2）的名字，为了减少不必要的麻烦，应该重做UI。</p>
<p>而.ui文件的备份也很重要，本人试过误操作得到了个惨重教训：对.ui文件执行了PyCharm里配置的autopep8工具，导致格式变化无法再被读取和修改，因此UI设计制作完毕，导出后应该做备份。只要UI文件在，就可以对UI进行修改调整，但是一旦丢失就很麻烦了。</p>
<p>备份好.ui文件后，就可以使用pyuic工具把它们转换为python文件，这里贴我的PyCharm设置：</p>
<p><img src="https://github.com/Hochikong/ckho-photolib/raw/master/20190302/01.png" alt="设置"></p>
<p>实际上命令是这样的：pyuic5 xxx.ui -x -o xxx.py</p>
<p>-x选项会自动为生成的python代码添加执行入口，即</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div></pre></td></tr></table></figure>
<p>-o指定输出的文件名，不过要注意不要把External Tools用在错误的文件上搞到格式混乱无法挽回就好了。</p>
<p>用pyuic5转换为py代码之后就可以开一个新文件（比如main.py）来写逻辑，以我的代码为例(dialog.py)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># Form implementation generated from reading ui file 'dialog.ui'</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Created by: PyQt5 UI code generator 5.11.3</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># WARNING! All changes made in this file will be lost!</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ui_Dialog</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUi</span><span class="params">(self, Dialog)</span>:</span></div><div class="line">        Dialog.setObjectName(<span class="string">"Dialog"</span>)</div><div class="line">        ...</div></pre></td></tr></table></figure>
<p>每个pyuic5转换后的代码都有注释警告不要在此文件中写别的内容，同时每个窗体都有一个以Ui_开头的类，我们只要在main.py里导入此类即可使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets</div><div class="line"></div><div class="line"><span class="comment"># when you run you should delete the . before textb</span></div><div class="line"><span class="keyword">from</span> textb <span class="keyword">import</span> Ui_MainWindow</div><div class="line"><span class="keyword">from</span> dialog <span class="keyword">import</span> Ui_Dialog</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.app = QtWidgets.QApplication(sys.argv)</div><div class="line"></div><div class="line">        self.main_window = QtWidgets.QMainWindow()</div><div class="line">        self.ui = Ui_MainWindow()</div><div class="line">        self.ui.setupUi(self.main_window)</div><div class="line"></div><div class="line">        self.dialog = QtWidgets.QDialog()</div><div class="line">        self.dialog_ui = Ui_Dialog()</div><div class="line">        self.dialog_ui.setupUi(self.dialog)</div><div class="line"></div><div class="line">        self.ui.textEdit.textChanged.connect(self.auto_save)</div><div class="line">        self.ui.actionOpen.triggered.connect(self.on_open_click)</div><div class="line">        self.ui.actionSave.triggered.connect(self.on_save_click)</div><div class="line">        self.ui.actionNew.triggered.connect(self.on_new_click)</div><div class="line"></div><div class="line">        self.main_window.show()</div><div class="line">        sys.exit(self.app.exec_())</div></pre></td></tr></table></figure>
<p>这里就导入了Ui_MainWindow和Ui_Dialog并且进行实例化，但是要注意的是，就算mian.py里有多个Ui实例，像</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.app = QtWidgets.QApplication(sys.argv)</div></pre></td></tr></table></figure>
<p>的代码也只需要写一行，上面的例子里，Dialog被执行setupUi之后并不会直接显示出来，而我们需要这个展示这个dialog的时候就需要执行show()和exec_()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dialog_alert</span><span class="params">(self, content)</span>:</span></div><div class="line">    self.dialog_ui.label.setText(content)</div><div class="line">    self.dialog_ui.pushButton.clicked.connect(self.dialog.close)</div><div class="line"></div><div class="line">    self.dialog.show()</div><div class="line">    self.dialog.exec_()</div></pre></td></tr></table></figure>
<p>这里我们总结一下解耦的原理：</p>
<p>1.设计转换UI为python代码。</p>
<p>2.在主程序入口里import UI转换后的类，实例化并添加逻辑代码，按需显示。</p>
<h4 id="打包exe"><a href="#打包exe" class="headerlink" title="打包exe"></a>打包exe</h4><p>虽然这个并不是重点，在Linux环境下直接安装依赖就可以跑起来，但对于我这种常年用Windows的人来说，打包exe肯定比直接在cmder里python xxx.py便捷。这里我觉得auto-py-to-exe这个工具比较好用。</p>
<p>用pip安装后就可以在console里启动这玩意：</p>
<p><img src="https://github.com/Hochikong/ckho-photolib/raw/master/20190302/02.png" alt="转换工具"></p>
<p>有趣的是，这玩意的GUI是用一个叫做Eel的库实现的，一个Python+Electron混合程序开发库，有兴趣的读者可以去了解下。</p>
<p>首先是Script Location，以我的代码为例，这里我们选择main.py，即记事本demo的程序入口。</p>
<p>Onefile选项的One Directory是表示打包为一个目录，目录的mian.exe是程序入口；第二个是打包为单个exe文件。就个人感觉，如果你的程序引用了以目录存放的资源（比如图标），或会在相对路径下的进行文件输出，最好是用One Directory，比如我的程序会引用源码包里icon\的文件，如果打包为单个exe，在exe的路径里若没有icon\目录，就无法显示图标。为了组织文件，你肯定需要一个目录把这些东西和其他文件隔离，所以为何不直接打包one directory？还可以做自安装包。</p>
<p>Console Window的第一个选项是程序运行时会带一个cmd黑框，后者则没有，为了美观，一般都是选择后者。</p>
<p><img src="https://github.com/Hochikong/ckho-photolib/raw/master/20190302/03.png" alt="Icon"></p>
<p>Icon展开后可以添加ico文件，这个主要是为了打包出来的exe文件的图标，而窗体的icon与此无关，窗体icon需要在Qt Designer里设置。</p>
<p>Addition Files是添加其他依赖资源，比如前面提到的icon\目录，可以用add folder添加，那么在打包出来的包里就会包含icon\目录，记事本demo的窗体icon也能正常显示。</p>
<p>Advance的内容我还没怎么试过，有兴趣的读者可以自行了解。</p>
<p>配置好之后直接按convert .py to .exe即可自动打包，途中应该会报类似的警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WARNING: lib not found: api-ms-win-crt-heap-l1-1-0.dll dependency of C:\Program Files (x86)\Python\python.exe</div></pre></td></tr></table></figure>
<p>我的平台是Win10 1803，实际上打包出来的exe无论在Win7还是Win10上都可以运行，因此直接无视就好了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个是我最终做出来的demo：</p>
<p><img src="https://github.com/Hochikong/ckho-photolib/raw/master/20190302/04.png" alt="记事本"></p>
<p>说实话，PyQt有Qt非常详细的文档可供参考，只要掌握开发PyQt应用的核心知识，开发GUI应用的难度一点都不比Electron高，甚至更加轻松。我也有意用PyQt重写一个之前用Electron+Vue实现的GUI应用。我还是非常推荐packt那门视频课程的，讲得非常有条理，例子也很好懂，当然Qt的官方文档（重点！是Qt的文档，而非PyQt的文档）也是非常有用，可以去<a href="https://doc.qt.io/qt-5/reference-overview.html" target="_blank" rel="external">这里</a>看。希望读者看了这篇文章能有所帮助吧。</p>
<p>Qt牛逼！</p>
<p>####################################################################</p>
<p>再推荐一个YouTube大佬的PyQt5系列视频<a href="https://www.youtube.com/channel/UCD6ArU-AYbfIj5sx2L4SZAQ" target="_blank" rel="external">教程</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PyQt5/">PyQt5</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-electronapptalk"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/08/13/electronapptalk/">Electron应用开发浅谈</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/08/13/electronapptalk/" class="article-date">
	  <time datetime="2018-08-13T09:09:09.000Z" itemprop="datePublished">2018-08-13</time>
	</a>

      
    <a class="article-category-link" href="/categories/随笔/">随笔</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本人在学校经常会控制不住自己的手，一有空就某宝，然后经常乱花钱，搞到生活费月月光，买了iPad之后，看到iOS上有款应用叫Pennis但是要花25元才能使用，反正又不是不会写，便自己写了个带UI的应用，即MMM，Month Money Manager，并基于Apache License 2.0许可证发布，<a href="https://github.com/Hochikong/MonthMoneyManager" target="_blank" rel="external">项目地址</a>。本文重点谈谈我在写这个东西时遇到的坑和相关问题。</p>
<h2 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h2><p>技术栈：bootstrap、vue.js、electron</p>
<p>辅助工具：<a href="https://www.layoutit.com/" target="_blank" rel="external">layoutit</a>，electron-forge</p>
<p>目录结构参考我的Github repo</p>
<p>下面简单讲讲数据的处理流程：</p>
<p>1.每次应用一打开，就会通过nodejs的fs模块检测用户数据文件是否存在，是则读取文件并设置两个属性：exists和data，前者表示用户数据是否存在，后者是数据的具体内容（一个JS Object），当exists为false的时候，通过函数生成一个带初始值的object，否则使用用户数据文件里的源数据object，同时main.js会在特定频道监听来自渲染端的请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">ipcMain.on(<span class="string">'RTOM'</span>, (event, arg) =&gt; &#123;</div><div class="line">    <span class="keyword">switch</span> (arg.head) &#123;</div><div class="line">        <span class="comment">// renderer query current cache every loading time, send a empty body</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'query'</span>: &#123;</div><div class="line">            event.sender.send(<span class="string">'MTOR'</span>, &#123;</div><div class="line">                exists: userDataExists,</div><div class="line">                data: userDataCache,</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> <span class="string">'update'</span>: &#123;</div><div class="line">            updateUserData(arg.body);</div><div class="line">            updateCache();</div><div class="line">            event.sender.send(<span class="string">'MTORUpdateView'</span>, &#123;</div><div class="line">                exists: userDataExists,</div><div class="line">                data: arg.body,</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">        <span class="comment">// empty</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在主进程里主要是靠ipcMain来收发信息，在RTOM上监听渲染端的数据，数据是一个JS object，当数据头部为query的时候，则把前面读取的文件是否存在和数据object发过去，ipcMain通过event.sender.send() 函数发送数据，并且可以指定频道，这里我用的是MTOR。同时ipcMain也要负责监听来自渲染端的更新请求，然后将渲染端发来的数据object写入本地文件，然后把那些数据通过MTORUpdateView频道再发回渲染端用于更新用户界面。上面的代码均为异步消息。</p>
<p>2.应用首先加载index.html，index.html先通过queryCache() 函数向main.js发送请求，发送请求后进行监听直到获取数据后才初始化创建vue实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">queryCache();</div><div class="line"></div><div class="line">    ipcRenderer.on(<span class="string">'MTOR'</span>, (event, arg) =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (arg.exists) &#123;</div><div class="line">            vueData.exists = <span class="literal">true</span>;</div><div class="line">            vueData.userCache = arg.data;</div><div class="line">            initalWork();</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> vueData.userCache === <span class="string">'object'</span>) &#123;</div><div class="line">                <span class="keyword">const</span> vm0 = <span class="keyword">new</span> Vue(&#123;</div><div class="line">                    el: <span class="string">"#indexView"</span>,</div><div class="line">                    data: vueData,</div><div class="line">                    computed: &#123;</div><div class="line">                        imgUrl: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                            <span class="keyword">return</span> vueData.needTips ? <span class="string">'./localimg/arrow.png'</span> : <span class="string">" "</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    methods: &#123;</div><div class="line">                        appendDayCost: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                            applyCostExec();</div><div class="line">                            alert(<span class="string">"已追加"</span>);</div><div class="line">                        &#125;,</div><div class="line">                        fixRemain: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                            fixRemainExec();</div><div class="line">                            alert(<span class="string">"已修正"</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            vueData.exists = <span class="literal">false</span>;</div><div class="line">            vueData.userCache = arg.data;</div><div class="line">            alert(emptyData);</div><div class="line">            <span class="keyword">const</span> allBtn = <span class="built_in">document</span>.getElementsByClassName(<span class="string">'btnBlock'</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; allBtn.length; i++) &#123;</div><div class="line">                allBtn[i].setAttribute(<span class="string">'disabled'</span>, <span class="string">'disabled'</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">const</span> vmfake = <span class="keyword">new</span> Vue(&#123;</div><div class="line">                el: <span class="string">"#indexView"</span>,</div><div class="line">                data: vueData,</div><div class="line">                computed: &#123;</div><div class="line">                    imgUrl: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                        <span class="keyword">return</span> vueData.needTips ? <span class="string">'./localimg/arrow.png'</span> : <span class="string">" "</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                methods: &#123;</div><div class="line">                    appendDayCost: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                        <span class="comment">// do nothing</span></div><div class="line">                    &#125;,</div><div class="line">                    fixRemain: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                        <span class="comment">// do nothing</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>要分析上面的代码，先从queryCache开始看：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">queryCache</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// 发送请求查询cache，不能直接用sendSync，ipcMain需要设置event.returnValue</span></div><div class="line">        ipcRenderer.send(<span class="string">'RTOM'</span>, generateCommu(<span class="string">'query'</span>));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ipcRenderer负责为渲染进程收发信息，ipcRenderer发送信息有两种方式：异步和同步，异步用send，同步用sendSync，但是要注意，sendSync发送的数据，ipcMain只有在设置了event.returnValue的值的时候才会响应听同步消息，不设置的话就是渲染页面无法正常显示。</p>
<p>当ipcRenderer接受到来自ipcMain的query应答，就检查数据中的exists为true还是false，若为true，则执行initialWork() ，initialWork的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initalWork</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">const</span> cacheMeta = vueData.userCache.meta;</div><div class="line">        <span class="keyword">if</span> (cacheMeta.recordYear === TODAY.year &amp;&amp; cacheMeta.recordMonth === TODAY.month) &#123;</div><div class="line">            <span class="keyword">if</span> (cacheMeta.recordDay &lt; TODAY.day) &#123;</div><div class="line">                <span class="comment">// 此处满足同年同月但不同日且今天比记录日后</span></div><div class="line">                updateCache(vueData.userCache);</div><div class="line">                writeCache();</div><div class="line">                cacheTOVueData();</div><div class="line">                dontNeedTips();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cacheMeta.recordDay === TODAY.day) &#123;</div><div class="line">                cacheTOVueData();</div><div class="line">                dontNeedTips();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                alert(outOfDate);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            alert(outOfDate);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>对main.js返回的文件内容进行检查，若同年同月且此刻是记录日期的第二天，则将部分用户数据重新计算并通过writeCache() 函数发送update消息到ipcMain，将数据写回本地，然后把数据更新到先前创建（在queryCache函数执行前）的vueData中，这样就向用户展示来自数据文件的数值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> vueData = &#123;</div><div class="line">        <span class="comment">// 基本属性</span></div><div class="line">        exists: <span class="literal">false</span>,</div><div class="line">        userCache: &#123;<span class="attr">name</span>: <span class="string">'jack'</span>&#125;,</div><div class="line">        needTips: <span class="literal">true</span>,  <span class="comment">// 判断要不要提醒用户设置预算</span></div><div class="line">        <span class="comment">// ----交换属性----</span></div><div class="line">        newTotal: <span class="number">0</span>,  <span class="comment">// 覆盖原来的total，最终同步到userCache</span></div><div class="line">        addCost: <span class="number">0</span>,  <span class="comment">// 每次输入的额，要加到todayCost</span></div><div class="line">        <span class="comment">// 使用计算属性 todayCredit</span></div><div class="line">        <span class="comment">// ----被动属性----</span></div><div class="line">        deposit: <span class="number">0</span>,</div><div class="line">        todayCredit: <span class="number">0</span>,</div><div class="line">        alCond: <span class="string">'alert-success'</span>,</div><div class="line">        cacheRemain: <span class="number">0</span>,  <span class="comment">// 从userCache获取</span></div><div class="line">        remain_days: <span class="number">0</span>,  <span class="comment">// 从userCache获取</span></div><div class="line">        al: <span class="string">'alert'</span>,</div><div class="line">        alDis: <span class="string">'alert-dismissable'</span>,</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>当用户执行追加本日开支和余额修正时，程序分别通过applyCostExec() 和 fixRemain() 进行操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyCostExec</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        vueData.userCache.user.dayCost += <span class="built_in">parseFloat</span>(vueData.addCost);</div><div class="line">        writeCache();</div><div class="line">        vueData.addCost = <span class="number">0</span>;</div><div class="line">        ipcRenderer.on(<span class="string">'MTORUpdateView'</span>, (event, arg) =&gt; &#123;</div><div class="line">            vueData.exists = arg.exists;</div><div class="line">            vueData.userCache = arg.data;</div><div class="line">            initalWork();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fixRemainExec</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        vueData.userCache.user.total = vueData.newTotal;</div><div class="line">        vueData.userCache.user.remain = vueData.newTotal - vueData.userCache.user.deposit;</div><div class="line">        vueData.userCache.user.dayAverage = vueData.userCache.user.remain / vueData.userCache.user.daysRemain;</div><div class="line">        writeCache();</div><div class="line">        vueData.newTotal = <span class="number">0</span>;</div><div class="line">        ipcRenderer.on(<span class="string">'MTORUpdateView'</span>, (event, arg) =&gt; &#123;</div><div class="line">            vueData.exists = arg.exists;</div><div class="line">            vueData.userCache = arg.data;</div><div class="line">            initalWork();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>以applyCostExec为例，首先把vueData中v-model的绑定的变量的值同步到userCache中，然后调用writeCache() 写入本地文件，重设v-model对应变量的值为0，然后监听来自ipcMain的数据并再次执行initialWork() ，重复index.html刚加载的时候的界面初始化流程，使用vue来更新用户界面主要是靠双向绑定减少重复工作，若使用jQuery实现同样的功能，代码量将会显著增加，而fixRemain的流程和applyCostExec也基本一致。</p>
<p>回到前面的分析，若main.js在index.html初始化的时候返回给index.html的数据中exists为false，则通过alert提醒用户未设置预算计划，同时通过vue的计算属性在用户界面展示一个箭头提醒用户设置计划。同时通过setAttribute禁用主界面的特定按钮，直到用户设置好计划为止。</p>
<p>至于config.html的逻辑则简单得多，只需要处理用户保存变更和查看about和help的动作就行了。js代码的结构与index.html差不多，一个vue数据对象负责双向绑定，当用户保存变更的时候就读取数据对象的值构造一个object发送给main.js保存在本地文件，然后用户点击“返回”的时候就让index.html执行前面介绍的流程，更新用户界面等。</p>
<h2 id="遇上的坑和关注点"><a href="#遇上的坑和关注点" class="headerlink" title="遇上的坑和关注点"></a>遇上的坑和关注点</h2><ol>
<li><p>异步通讯，根据前面描述的逻辑，vue负责更新用户界面，但是前提是本地文件储存的数据要先更新到vueData中。如果创建vue实例的代码在和ipcRenderer监听的代码处于同一命名空间的话，就会导致渲染网页的时候vue获取不了来自异步通讯的数据而是直接读取页面初始化时生成的vueData，从而报错导致页面刷不出来，而且这个阶段只有开发环境版的vue.js能提醒问题出在什么地方。建议在开发阶段使用vue的开发环境版本，并且开启devtools用于调试。vue实例必须在异步数据到达之后才创建，不然会报错。或者使用同步通讯，但是要注意ipcMain的returnValue的设置。</p>
</li>
<li><p>生成的程序，窗口标题由不同html的title决定，而对话框的标题，由package.json的productName决定。</p>
</li>
<li><p>建议使用electron-forge初始化一个新的electron项目，免去手动配置boilerplate。</p>
</li>
<li><p>electron-forge的图标设定不会在编译前起效，即你执行electron-forge start的时候，你设置的icon是不会显示的，因为icon的设置是在程序打包的时候才设置的，所以要看到图标的效果只能make完再查看。</p>
</li>
<li><p>Apache License的使用，除了在根目录放LICENSE（通常能通过github直接创建），还要在源码的头部放上一份包含自己信息的声明：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Copyright [yyyy] [name of copyright owner]</div><div class="line"> Licensed under the Apache License, Version 2.0 (the "License");</div><div class="line"> you may not use this file except in compliance with the License.</div><div class="line"> You may obtain a copy of the License at</div><div class="line"></div><div class="line"> http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"></div><div class="line"> Unless required by applicable law or agreed to in writing, software</div><div class="line"> distributed under the License is distributed on an "AS IS" BASIS,</div><div class="line"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line"> See the License for the specific language governing permissions and</div><div class="line"> limitations under the License.</div></pre></td></tr></table></figure>
<p>方括号内的内容由自己填写，不保留方括号。关于Apache License的使用可以参考这个：<a href="http://adoyle.me/blog/how-to-apply-the-apache-2-0-license-to-your-project.html" target="_blank" rel="external">教程</a></p>
<p>如果包含第三方库，我参考了Apache Spark项目的做法，在LICENSE后追加说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">------------------------------------------------------------------------------------</div><div class="line">   This product bundles various third-party components under other open source licenses.</div><div class="line">   This section summarizes those components and their licenses. See licenses/</div><div class="line">   for text of these licenses.</div><div class="line"></div><div class="line"></div><div class="line">   MIT License</div><div class="line">   -----------</div><div class="line"></div><div class="line">   local-lib/bootstrap.min.css</div><div class="line">   local-lib/bootstrap.min.js</div><div class="line">   local-lib/jquery.slim.min.js</div><div class="line">   local-lib/popper.min.js</div><div class="line">   local-lib/vue.js</div></pre></td></tr></table></figure>
<p>然后在根目录创建一个licenses目录，里面放上对应项目的license原文，并且根目录的NOTICE也要加上相关说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Month Money Manager</div><div class="line">Copyright 2018 Hochikong</div><div class="line"></div><div class="line">Bootstrap</div><div class="line">Copyright (c) 2011-2018 Twitter, Inc.</div><div class="line">Copyright (c) 2011-2018 The Bootstrap Authors</div><div class="line"></div><div class="line">jQuery</div><div class="line">Copyright JS Foundation and other contributors, https://js.foundation/</div><div class="line"></div><div class="line">popper.js</div><div class="line">Copyright © 2016 Federico Zivolo and contributors</div><div class="line"></div><div class="line">Vue.js</div><div class="line">Copyright (c) 2013-present, Yuxi (Evan) You</div></pre></td></tr></table></figure>
<p>其他人的实践例子：<a href="https://softwareengineering.stackexchange.com/questions/234511/what-is-the-best-practice-for-arranging-third-party-library-licenses-paperwork" target="_blank" rel="external">链接</a></p>
</li>
<li><p>建议直接用npm处理问题，比如npm install安装依赖，npm run make编译，虽然实际上调用的是electron-forge make。npm install途中可能会报错，删掉node_modules再重试几遍会比较好。</p>
</li>
<li><p>bootstrap的部分界面特效（比如弹窗）无法在electron app中使用。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Electron+Vue+Bootstrap的GUI应用开发难度应该是比Qt等库更加简单，而且具备跨平台的能力，如果熟悉了Electron中的套路，开发第二第三个electron app应该就更容易了。最重要还是要熟悉node.js那些操作，才能实现和本地软件的交互。</p>
<p>在此特别感谢<a href="https://www.jianshu.com/u/a7454e40399d" target="_blank" rel="external">鳗驼螺</a> ，他的这篇文章算是个非常经典的electron app开发教程，无论是上下文菜单还是窗口菜单、对话框等，都有详细的介绍，感谢他的贡献，我才能顺利开发这个electron 应用。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/electron/">electron</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-productiveipad2018"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/06/13/productiveipad2018/">如何让iPad变成真正的生产力工具</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/06/13/productiveipad2018/" class="article-date">
	  <time datetime="2018-06-13T12:57:05.000Z" itemprop="datePublished">2018-06-13</time>
	</a>

      
    <a class="article-category-link" href="/categories/随笔/">随笔</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="怎么选了iPad-2018？"><a href="#怎么选了iPad-2018？" class="headerlink" title="怎么选了iPad 2018？"></a>怎么选了iPad 2018？</h1><p>最近手上多了笔钱，本来之前是考虑买一个1000多的国产Windows平板用来看电子书和作为廉价Surface用，但是看了下淘宝，1500以内的基本都是z8350的处理器，而Android平板主要是App不太行，所以选择加钱买iPad 2018，主要是看中它支持apple pencil。买之前我在知乎上看了下，不少人说2018款的非全贴合屏垃圾，刷新率不及pro，建议加钱入二手pro 9.7或者还在卖的pro 10.5。实际上我入手后（国行，深空灰128G WiFi版），的确是能感受到屏幕上的问题，但是实际使用时对于我影响不大，买的深空灰黑色面板还看不出大黑边。就只有知乎个个年薪百万的随随便便就说加钱买Pro，真的当那2000不是钱啊！iPad 2018 32G版对于学生党来说真的是超高性价比的苹果设备了，当然土豪是不需要性价比的，不过如果去港澳买的话、通过汇率可以将128G版的价格压到2600RMB左右。   </p>
<p>我不是苹果全家桶用户，手上使用的设备是一台神舟游戏本+普通21寸IPS面板的显示器、小米6和这台iPad。文章接下来的内容主要是介绍我日常如何在学习上发挥iPad的作用。</p>
<h1 id="基本盘"><a href="#基本盘" class="headerlink" title="基本盘"></a>基本盘</h1><p>首先是斧乃木妹妹的亮相 : )</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/85187673.jpg" alt="Yay!Peace,Peace"></p>
<h2 id="1-基本办公软件："><a href="#1-基本办公软件：" class="headerlink" title="1.基本办公软件："></a>1.基本办公软件：</h2><p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/89928956.jpg" alt="http://oy30yrqej.bkt.clouddn.com/apps1.png"></p>
<p>我主要是使用MS全家桶，Word、Excel、PowerPoint三个，还有Outlook、OneNote和OneDrive，Office Lens主要是方便扫描后导出文档（虽然iPad的摄像头真的不咋样，但是扫描文件、上课拍个PPT还是没问题的），因为我不是苹果全家桶，因此以跨平台的软件优先，To Do是微软出品的一款待办事项工具，支持Android、iOS和Windows，这样我的待办事项能同时在三个平台编辑和查看。而OneDrive主要作为跨平台交换文件的网盘，在国内因为某些原因网页版被DNS污染无法使用，但是客户端可以正常用，而且速度不慢，我一般会在电脑上下载好需要看的PDF然后直接复制到Win 10的OneDrive目录里，然后就可以在iPad上访问，拷贝到PDF阅读器或者保存在Documents（一个免费文件App）里，OneDrive默认只有5G，如果是365用户可以获得1T容量，还可以另外充值每个月1.49刀左右扩容至50G，这里我的选择是去淘宝找扩容服务，通过邀请好友的方式让容量扩张到最高15G，虽然不是太大，但是用于文件交换是足够了。虽然iOS 11提供了“文件”应用，但是Documents更方便，推荐使用。</p>
<h2 id="2-Coding之类："><a href="#2-Coding之类：" class="headerlink" title="2.Coding之类："></a>2.Coding之类：</h2><p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/6356860.jpg" alt=""></p>
<p>有时可能需要远程控制自己的PC编辑代码，因此TeamViewer对于我来说是很有用的一个软件，用VNC之类的工具就能搞定远程代码编辑和电脑的维护，所以SSH对于我来说也很重要，有时需要远程连接Linux服务器，我使用的是Termius，免费使用。GoCoEdit是一个类似sublime text的软件，这个软件适合临时在本地写代码，但是不支持自动补全（估计很难提供）。Textcode Viewer是用来获取github上的repo进行code review。</p>
<h2 id="3-其他："><a href="#3-其他：" class="headerlink" title="3.其他："></a>3.其他：</h2><p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/4141492.jpg" alt=""></p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/51098185.jpg" alt=""></p>
<p>Myscript Calculator可以手写计算，支持解方程之类的，但是写字太难看的人还是别用了…识别率还是比较感人，还不如直接下个正常的计算器app或者直接用CASIO算。  </p>
<p>ShadowRocket，不用多说，懂行的人都知道，不过需要搞个美区ID购买， 搞一个美区ID最省事的方法就是某宝。  </p>
<p>Chrome、Gmail、Google Drive和Google，因为我手机电脑都是用Chrome，跨设备同步非常方便，所以iPad理所当然是用Chrome，Gmail方便收右键，Google全家桶还不错。   </p>
<p>Grammarly，需要英文输入时可以切换这个输入法，支持蓝牙键盘，自动校正英文的输入错误。   </p>
<p>Workflow和IFTTT，自动化操作，目前我编辑了一个flow可以直接在浏览器复制url然后一键生成PDF导入笔记软件阅读和写笔记。   </p>
<p>AnyRate，计算汇率，但是MIUI自带的计算器也可以计算汇率就是了。     </p>
<p>白描，个人非常推荐的一个OCR软件，虽然有人推荐ScannerPro，但是OCR的速度真的非常感人，白描只要6元人民币，识别效果和速度都很好，自带校正窗口，方便修改错误的地方，强烈推荐。    </p>
<p>iPad似乎没有预装任何扫二维码的工具，我使用的是卡巴斯基的QR Scanner，毕竟二维码攻击还是存在的，我PC也是用的卡巴斯基KAV，信得过卡巴的软件。   </p>
<h1 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h1><p>我买iPad的首要目的是阅读和笔记。阅读的主要内容是自己找的PDF和电子书阅读客户端里的内容，翻译工具也是不能缺少的。而笔记主要是将笔记数字化，方便在任何设备上查看和阅读，之前上课是用手写笔记然后下课后回宿舍录入电脑，但是问题在于重复劳动，而且在买数位板之前无法在电脑上画东西（思维导图、流程、构思等），在买iPad之前我还入了一块Wacom 472，方便在电脑上记录笔迹数据。   </p>
<p><img src="http://oy30yrqej.bkt.clouddn.com/apps2.png" alt=""></p>
<p>阅读PDF可以用免费的Adobe Acrobat或者其他，不过我看bundle有折扣就入了PDF Expert与PDF Converter，前者是专门阅读PDF的软件，还有非常强大的PDF批注功能，不过我的垃圾电容笔批注实在不好用，写字写得像翔一样，等迟些入apple pencil再看看效果如何。词典推荐韦氏词典，翻译工具推荐欧路词典和极光词典，欧路词典可以自动跨取词翻译，而极光词典是我尝试过的产品里唯一支持分屏的翻译软件，同时也可以右键复制自动翻译。我买iPad的另一个主要原因是拿来读书，不想买太多纸质书没地方放，正版书可以通过Kindle或者多看获取，这里我使用的是多看阅读，可以购买各种电子书，个人尤其喜欢中信出版社的经济类书。     </p>
<p><img src="http://oy30yrqej.bkt.clouddn.com/apps3.png" alt=""></p>
<p><img src="http://oy30yrqej.bkt.clouddn.com/goodnotes.png" alt=""></p>
<p>笔记主要是用GoodNotes与Notes Plus，Notes Plus的防误触比较适合速记，而且有笔迹优化，我的辣鸡电容笔也能写出比较好看的字，但是在PDF Expert和OneNote这种没有手写优化的软件里我的字迹就真的不堪入目。Good Notes比较适合阅读并笔记，可以导入PDF，对手写的优化不错，可以写出小字体，上课的时候也可以即时拍照加入笔记，即时做笔记然后不用等到下课再花时间整理。而Notability对我手上的这种电容笔支持不佳，但不清楚apple pencil的效果如何。MarginNote适合做思维导图，也可以导入PDF、EPUB之类的文件，适合深度思考和整理时用。    </p>
<p><img src="http://oy30yrqej.bkt.clouddn.com/Notehighlight.png" alt=""></p>
<p><img src="http://oy30yrqej.bkt.clouddn.com/onenoteweb.png" alt=""></p>
<p>OneNote主要是跨平台阅读，我会把iPad上整理的笔记重新导出，添加到OneNote里，然后在OneNote里添加索引方便全文检索，OneNote相当于是核心知识库，被用于查阅，而那些笔记软件是工作台，整理资料被用于录入。一般录入就要回到PC，OneNote 2016可以使用NoteHighlight插入代码并高亮，而另一个Chrome扩展OneNote Web Clipper可以对网页进行完整或者局部截图然后自动导入OneNote，方便截取网页保存。OneNote的优势在于跨平台和自带OCR，这个OCR主要作用在搜索上，对于笔迹和图片上的文字都可以识别出来，这就是我用它做核心知识库的原因。电脑上配合数位板也可以在OneNote上画画写写，但是依然没有手写优化，写的字真的不如我用OpenCanvas这个画画工具写得好。所以最好还是拿来整理查阅比较好。   </p>
<h1 id="外设"><a href="#外设" class="headerlink" title="外设"></a>外设</h1><p><img src="http://oy30yrqej.bkt.clouddn.com/alldevices.jpg" alt=""></p>
<p>外设我就买了一个罗技k380和一支30来块的电容笔还送了防误触手套，罗技k380对iPad的兼容性很好，但是！有个问题，默认iOS的智能标点是开的，会导致蓝牙键盘输入全角的引号，而远程写代码的时候总不可能手动复制半角引号吧？此时需要在“设置-&gt;通用”里面关闭“智能标点”，然后才能正常地用蓝牙键盘输入半角引号。   </p>
<p>电容笔的话，我估计…是估计，apple pencil是最好的选择，或者罗技那个crayon，淘宝上其他品牌的电容笔主要分国产和境外品牌，国产的话主要还是那种笔头是圆盘或球的（30~10元）的被动式和尖头（250~150元）的主动式笔，如果预算不够，买圆盘的那种就最好了，不过要配合前面介绍的一些软件使用才能写得好，而画画的话圆盘笔还是算了，精度不够，总觉得圆盘碍事，还要戴防误触手套画（数位板表示“有电磁感应真的可以为所欲为的”），而贵一点的国产主动式电容笔主要在250以内能提供尖笔头，不过某些淘宝爆款的笔头是硬的，写的时候会很吵，没买过不清楚体验如何。境外品牌有罗技、Wacom、Adonit、Dagi（台湾）等。罗技的笔是crayon，被称为廉价版AP，不过外观真的不怎样，这名字也让人觉得是那种儿童画笔，但400多能搞定，但是某宝上似乎只有一家在卖…Wacom的笔价位主要在700~90以内，不太推荐某支89元（截至写本文时）的笔，实际上还是被动式的，但是是球型笔头，而且贴膜后使用会有debuff。其他的主动式笔都是尖头的，但是体验不知怎样。Adonit在知乎上比较多人说买了，这家提供圆盘、球和尖头三种笔，国内有卖，但是部分笔的价格我觉得可以干脆入AP，但是若不是2018款iPad或者Pro的话可以考虑这家。Dagi达际主要卖的是圆盘笔，不过我不太喜欢圆盘的就是了。说了那么多，我能提供的建议就是：2018款或者Pro用户，需要最好的笔记和绘画体验就apple pencil；其他的iPad用户，可以根据情况买Wacom或者Adonit的主动式笔；缺钱的、简单体验的就国产圆盘或者Wacom低于150的款式；不确定要不要高端笔的，可以入国产主动式；不缺钱的土豪，可以把上面说的厂家的笔全都买一遍，整理个体验报告造福人类；野路子的，薯片袋、电池负极、锡纸等材料自己做一根。    </p>
<h1 id="我怎样用iPad作为学习-生产工具"><a href="#我怎样用iPad作为学习-生产工具" class="headerlink" title="我怎样用iPad作为学习/生产工具"></a>我怎样用iPad作为学习/生产工具</h1><p>我最近在学Vue.js，我先在iPad的Chrome上打开网页复制Vue文档的url，然后用Workflow一键生成PDF导入GoodNotes，然后课间阅读文档、理解、做笔记。然后在空闲、在宿舍的时候转到电脑上打开IDE写代码实践所学的内容，最后整理代码和写代码途中遇到的问题录入OneNote，并把中途的全部参考资料通过OneNote Web Clipper导入OneNote作为reference，防止以后再查阅的时候网站链接不可用然后丢失这些参考内容。   </p>
<p>上课的时候用相机拍老师的PPT，在笔记软件上直接记录老师的讲课内容，相当于纸质笔记本，这个时候主要是要求速记，所以字就写得比较随便，课后在电子版参考资料上整理笔记，整理思维导图之类。   </p>
<p>少买/不买实体书了，通过多看阅读或者自己找PDF文件看，同时把笔记直接写在PDF上，节省买实体书的部分成本或者直接白嫖一本书，而且还不需要额外的空间放实体书。   </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>可能是我心态老了，或者就是纯粹的没兴趣，我的iPad买回来就只装了3个游戏，一个GRID Autosport，但是太硬核了，玩不下去，Real Racing 3好歹还能玩；第二个游戏是微软的Solitaire，就是Win10上面的纸牌游戏集合，休闲玩玩，还有个电音弹珠…仅此而已，崩崩崩、FGO那些我都没什么兴趣，玩那些掌上游戏还不如去玩3DS、PSV…对于我来说，iPad真的是无纸化、低成本阅读和外出代替我那2.5 Kg的游戏本处理轻量级任务最好的选择，变成游戏机、视频机？不存在的，游戏机我还少么…iPad于我是真正的生产力工具，也希望本文对读完全文的你有所参考。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iPad/">iPad</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-kotlinandjavacomment"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/05/29/kotlinandjavacomment/">评论一篇关于Kotlin与Java的文章</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/05/29/kotlinandjavacomment/" class="article-date">
	  <time datetime="2018-05-29T14:57:08.000Z" itemprop="datePublished">2018-05-29</time>
	</a>

      
    <a class="article-category-link" href="/categories/Kotlin学习/">Kotlin学习</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>经过一段时间，我已经把Kotlin的学习基本搞定，虽然最近在学Vue.js，但是还是有在关注Kotlin的事。今天偶然看到一篇<a href="https://allegro.tech/2018/05/From-Java-to-Kotlin-and-Back-Again.html" target="_blank" rel="external">文章</a>，讲的是Allegro（一家波兰的购物平台，可能是类似淘宝的网站）从Java转到Kotlin又转回Java的事。背景是Allegro在2017年夏天计划写个微服务，为了尝试新的技术然后转到Kotlin上，使用Groovy+Spock做测试，而在2018年他们又把微服务用Java重写，跑在Java10上。</p>
<h2 id="为什么选择Java而不是Kotlin，下面是他们提出的观点"><a href="#为什么选择Java而不是Kotlin，下面是他们提出的观点" class="headerlink" title="为什么选择Java而不是Kotlin，下面是他们提出的观点"></a>为什么选择Java而不是Kotlin，下面是他们提出的观点</h2><h3 id="1-Name-Shadowing"><a href="#1-Name-Shadowing" class="headerlink" title="1.Name Shadowing"></a>1.Name Shadowing</h3><p>这个东西我也不太清楚该怎么翻译，但是理解起来就是Kotlin没有做到这一点。在Python里，我们知道函数体内部的同名变量会自动屏蔽外部作用域的同名变量，参考下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>num = <span class="number">2</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">inc</span><span class="params">(x)</span>:</span></div><div class="line"><span class="meta">... </span>    num = <span class="number">1</span></div><div class="line"><span class="meta">... </span>    print(num+x)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>inc(<span class="number">1</span>)</div><div class="line"><span class="number">2</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>inc(<span class="number">2</span>)</div><div class="line"><span class="number">3</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<p>可以看到即使外部定义了num=2，但是在函数体内num=1。而他们给出了一个有点勉强的例子：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">fun</span> <span class="title">inc</span><span class="params">(num : <span class="type">Int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">val</span> num = <span class="number">2</span></div><div class="line">    <span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">val</span> num = <span class="number">3</span></div><div class="line">    &#125;</div><div class="line">    println (<span class="string">"num: "</span> + num)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码执行inc(1)，得到的结果是2，意味着只是纯粹的将方法体内第一个num的结果打印了出来，而if的代码块里却又定义了一个同名的变量。他们的意见是：这种代码在Java里是无法通过编译的，因为不能在同一方法作用域里同时定义两个同名变量，但是Kotlin却让这种代码通过了。实际上上面的代码，在IDEA里会提示if语句里的num没有被使用，如果关注方法体内的无用变量的话就会发现这种问题，然而，最重要的一点是，我不清楚谁会写出这样的代码：在同一函数体内定义两个同名变量却指望的是第一个变量的值发生变化。这种错误我觉得纯粹是程序员自己的问题，而不算语言的问题，语言不背这个锅，不写单元测试别赖IDE和语言把你带坑里。</p>
<h3 id="2-类型推导"><a href="#2-类型推导" class="headerlink" title="2.类型推导"></a>2.类型推导</h3><p>Java10可以使用类似JavaScript的方式定义变量，不需要显式声明变量类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var a = <span class="string">"10"</span>;</div></pre></td></tr></table></figure>
<p>我觉得这不是什么太大的问题，而且为什么你们公司这么快就敢上Java10？没有任何迁移成本？</p>
<h3 id="3-空安全"><a href="#3-空安全" class="headerlink" title="3.空安全"></a>3.空安全</h3><p>Kotlin经常强调空安全的问题。但是一旦与Java交互的话，Java可能会毁掉Kotlin的空安全机制。Kotlin里变量无非是两种类型，T与T?，后者表示变量可空，但是有一种特殊类型，来自Java代码的T!，表示类型未确定，可能是T也可能是T?，这样就会导致难以预测的问题。参考下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">format</span><span class="params">(String text)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> text.isEmpty() ? <span class="keyword">null</span> : text;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的Java函数可能返回null也可能返回字符串，如果在Kotlin里调用这个函数的话，返回的是T!，如果不经处理直接val f:String = Utils.format(text)，就没有考虑到该方法可能会返回null，从而抛出了NPE。或者使用elvis运算符，当format返回null的时候设置返回值为一个空字符串；再或者使用”?.”实现安全调用，或者不指定f的变量类型，但是也会抛出NPE，当然可以使用Kotlin不建议的”!!”，声明f不为T?，但是还是会抛NPE。我觉得这个的确是Kotlin的问题，搞了个T!的平台类型，导致复杂化，但是我个人认为最佳实践是用elvis。希望在后面的版本里Kotlin能着手解决这个问题。</p>
<h3 id="4-类的字面值-Class-literals"><a href="#4-类的字面值-Class-literals" class="headerlink" title="4.类的字面值(Class literals)"></a>4.类的字面值(Class literals)</h3><p>在Java里，可以直接通过CLASS.class获取字面值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Gson gson = <span class="keyword">new</span> GsonBuilder().registerTypeAdapter(LocalDate.class, <span class="keyword">new</span> LocalDateAdapter()).create();</div></pre></td></tr></table></figure>
<p>但是Kotlin里分了两种class，KClass与Class：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> kotlinClass : KClass&lt;LocalDate&gt; = LocalDate::<span class="class"><span class="keyword">class</span></span></div><div class="line"><span class="keyword">val</span> javaClass : Class&lt;LocalDate&gt; = LocalDate::<span class="class"><span class="keyword">class</span>.<span class="title">java</span></span></div></pre></td></tr></table></figure>
<p>KClass是Kotlin特有的反射API，用kotlin-reflect的时候基本都是基于KClass的。虽然我看到有些资料说建议用Java反射之类的。不过Kotlin的这种字面值的确用起来较为繁琐。</p>
<h3 id="5-相反位置的类型声明"><a href="#5-相反位置的类型声明" class="headerlink" title="5.相反位置的类型声明"></a>5.相反位置的类型声明</h3><p>Java里类型声明是放在变量前面的，但是Kotlin是放在变量后面中间还隔了个”:”，他们的意见是：1.为什么要把类型和变量隔开。 2.代码太长的时候（函数签名），函数的返回类型看起来不方便，需要拖动…如果函数签名里的参数一行一行地放，也不方便看返回类型。3.不方便命名变量名…他们想的是让IDE提示去快速书写变量名，但是Kotlin里只能自己手写。</p>
<p>一个看返回类型不太直观的例子：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">fun</span> <span class="title">kafkaTemplate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">        <span class="meta">@Value(<span class="meta-string">"\$&#123;interactions.kafka.bootstrap-servers-dc1&#125;"</span>)</span> bootstrapServersDc1: <span class="type">String</span>,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="meta">@Value(<span class="meta-string">"\$&#123;interactions.kafka.bootstrap-servers-dc2&#125;"</span>)</span> bootstrapServersDc2: <span class="type">String</span>,</span></span></div><div class="line"><span class="function"><span class="params">        cloudMetadata: <span class="type">CloudMetadata</span>,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="meta">@Value(<span class="meta-string">"\$&#123;interactions.kafka.batch-size&#125;"</span>)</span> batchSize: <span class="type">Int</span>,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="meta">@Value(<span class="meta-string">"\$&#123;interactions.kafka.linger-ms&#125;"</span>)</span> lingerMs: <span class="type">Int</span>,</span></span></div><div class="line"><span class="function"><span class="params">        metricRegistry : <span class="type">MetricRegistry</span></span></span></div><div class="line"><span class="function"><span class="params">)</span></span>: KafkaTemplate&lt;String, ByteArray&gt; &#123;</div><div class="line"></div><div class="line">    <span class="keyword">val</span> bootstrapServer = <span class="keyword">if</span> (cloudMetadata.datacenter == <span class="string">"dc1"</span>) &#123;</div><div class="line">        bootstrapServersDc1</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于这点，我受影响不大，保留意见。我也基本没有因为Kotlin和Java的变量类型位置不同导致不便。</p>
<h3 id="6-伴生对象"><a href="#6-伴生对象" class="headerlink" title="6.伴生对象"></a>6.伴生对象</h3><p>Kotlin里使用companion object实现”静态对象“，companion object的效果类似Java的static，但是并不是真正的静态对象，要使用真正的静态对象需要通过注解@JvmStatic来声明。他们遇到的问题似乎是Spring需要用”真正的静态对象“启动App：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRunner</span> </span>&#123;</div><div class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</div><div class="line">        <span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</div><div class="line">            SpringApplication.run(AppRunner::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">*args)</span></span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不过我个人认为难以判断好坏，因为Kotlin不需要另外声明一个Utils类再写静态方法，我只需要像Python一样直接在一个专门存放公共静态函数的kt文件里写一个全局的函数即可，静态与否意义不大。当然这个是看情况的，需要用Java的static还是要记得加注解。</p>
<h3 id="7-生成collection"><a href="#7-生成collection" class="headerlink" title="7.生成collection"></a>7.生成collection</h3><p>他们觉得Kotlin的集合声明不太直观，的确，js、py里声明一个array或者list只需要一个[ ]就能搞定，生成一个object或者dict也是只要一个{ }，但是Kotlin里需要用些函数比如listOf()、mapOf()来生成list和map，而且map还是用”to”这种奇葩格式来区分键值对，这一点我倒是挺赞同他们的，为什么非得用些繁琐的手段生成数据？希望后面的迭代能改变这一点。</p>
<h3 id="8-Optional值的缺失"><a href="#8-Optional值的缺失" class="headerlink" title="8.Optional值的缺失"></a>8.Optional值的缺失</h3><p>Java 8 开始，引入了Optional，意味着Stream可能无返回值也可能有返回，Java 8的lambda通过orElse()和ifPresent()处理Optional值。Kotlin则缺乏这方面的支持。我保留意见，从Python来的习惯，一条路走到黑：“当存在多种可能，不要尝试去猜测，而是尽量找一种，最好是唯一一种明显的解决方案”，用elvis就是一把梭（此处应有王守海表情包）！</p>
<h3 id="9-数据类"><a href="#9-数据类" class="headerlink" title="9.数据类"></a>9.数据类</h3><p>他们认为数据类Data Class局限多，因为是final，无法继承，所以在某些场合不适用。但他们也承认没有更好的办法，只能手写equals之类的。</p>
<h3 id="10-类默认是final的"><a href="#10-类默认是final的" class="headerlink" title="10.类默认是final的"></a>10.类默认是final的</h3><p>Kotlin里所有类默认都是final，想让它能继承需要加open修饰符，或者用一个插件kotlin-allopen。他们认为这是具有争议的，但是从我个人来看这没什么问题，只是写个open而已，而且想玩花样，代理模式、装饰器模式都是能用的…</p>
<h3 id="11-陡峭的学习曲线"><a href="#11-陡峭的学习曲线" class="headerlink" title="11.陡峭的学习曲线"></a>11.陡峭的学习曲线</h3><p>这点…你们开心就好，我学习Kotlin也没花太长时间，要比学习曲线你干嘛不跟Scala比？当然相对Groovy的确需要些时间，但是我学它真的没花多久时间…而且我是学了Kotlin才正式、认真地学Java的。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>当然，我写这篇东西并不是为了反驳他们，对于他们的工作环境、团队而言，Java 10可能是更好的选择，他们也是再三强调那篇东西并不是为了吹捧Java看衰Kotlin。对于我个人来说，自己做项目更多的还是会考虑Kotlin，毕竟写纯Java我是有点嫌弃的，虽然IDEA聪明得很，但是还是经常要按快捷键生成模板代码，而且我是从Python转过来的，Kotlin在某种程度来说比Java更让人有熟悉的感觉。btw，只有low逼会为了某个OS、技术而和别人争个你死我活，干活的人都是什么适合就用什么，不能赚钱、创造影响力有何意义？</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kotlin/">Kotlin</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-kotlinconstructor"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/02/01/kotlinconstructor/">Kotlin的Constructor总结</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/01/kotlinconstructor/" class="article-date">
	  <time datetime="2018-02-01T05:38:54.000Z" itemprop="datePublished">2018-02-01</time>
	</a>

      
    <a class="article-category-link" href="/categories/Kotlin学习/">Kotlin学习</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近开始学Kotlin，买了本《Kotlin极简教程》，以后绝对不要在京东阅读上买计算机的电子书，坑爹，我又去买了本实体版。最近看到面向对象这章，本文探讨了下构造函数的一些问题</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>构造函数简单而言就是在创建类的实例时调用的函数。Kotlin中如果没有可见修饰符或者注解(annotation)，就可以忽略不写constructor，反之则要写。修饰符和注解都要写在constructor前面。</p>
<p>Kotlin支持类有一个主构造函数和一到多个次构造函数。使用次构造函数可以根据参数的不同创建不同的实例。比如下面的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">class Person  constructor(val sex: String, val age: Int, val name: String)&#123;</div><div class="line">    var weight:Double = 0.0</div><div class="line">    init &#123;</div><div class="line">        println(&quot;The sex is $sex&quot;)</div><div class="line">        println(&quot;The age is $age&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    constructor(sex: String, age: Int, name: String, weight: Double):this(sex,age,name)&#123;</div><div class="line">        this.weight = weight</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以这样调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fun main(args: Array&lt;String&gt;)&#123;</div><div class="line">    val p1 = Person(&quot;male&quot;,23,&quot;jack&quot;)  //调用的主构造函数</div><div class="line">    println(&quot;All property of p1 is: sex-&gt;$&#123;p1.sex&#125;,age-&gt;$&#123;p1.age&#125;,name-&gt;$&#123;p1.name&#125;&quot;)</div><div class="line">    val p2 = Person(&quot;female&quot;,16,&quot;Michelle&quot;,45.7)  //调用次构造函数</div><div class="line">    println(&quot;The weight of P2 is $&#123;p2.weight&#125;&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回的结果是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">The sex is male</div><div class="line">The age is 23</div><div class="line">All property of p1 is: sex-&gt;male,age-&gt;23,name-&gt;jack</div><div class="line">The sex is female</div><div class="line">The age is 16</div><div class="line">The weight of P2 is 45.7</div></pre></td></tr></table></figure>
<p>次构造函数的函数签名不能有val或者var，而且必须通过this委托给主构造函数。</p>
<p>注意！</p>
<p>1.只能在主构造函数里用init{}</p>
<p>2.这样的代码是错的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class Person  constructor(val sex: String, val age: Int, val name: String)&#123;</div><div class="line">    init &#123;</div><div class="line">        println(&quot;The sex is $sex&quot;)</div><div class="line">        println(&quot;The age is $age&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    constructor(sex: String, age: Int, name: String, weight: Double):this(sex,age,name)&#123;</div><div class="line">        val weight: Double = weight</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果想正确地访问weight变量，只能在主构造函数里创建变量并赋值（不然IDE会提示要不非抽象属性或者要初始化），然后通过this在次构造函数里赋合适的值。无法在次构造函数里创建val或者var</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kotlin/">Kotlin</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-tradeserverupdaterecord"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/12/21/tradeserverupdaterecord/">修bug记录</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/12/21/tradeserverupdaterecord/" class="article-date">
	  <time datetime="2017-12-21T04:50:02.000Z" itemprop="datePublished">2017-12-21</time>
	</a>

      
    <a class="article-category-link" href="/categories/to-Quant/">to Quant</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近修复了stockclib的恶性bug和为TradeServer增加了点功能。把开发途中的重点记录下。</p>
<h3 id="logging配置多个日志文件"><a href="#logging配置多个日志文件" class="headerlink" title="logging配置多个日志文件"></a>logging配置多个日志文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def generate_logger(name, log_file, level=logging.INFO):</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    通用的日志记录模块，用于不同功能的日志记录工作</div><div class="line">    :param name: logger名</div><div class="line">    :param log_file: 日志文件</div><div class="line">    :param level: 日志级别，默认INFO</div><div class="line">    :return: logger对象</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    handler = logging.FileHandler(log_file)</div><div class="line">    handler.setFormatter(formatter)</div><div class="line"></div><div class="line">    logger = logging.getLogger(name)</div><div class="line">    logger.setLevel(level)</div><div class="line">    logger.addHandler(handler)</div><div class="line"></div><div class="line">    return logger</div></pre></td></tr></table></figure>
<p>通过这个函数可以生产logger对象，并且能指定文件来记录日志内容。交易服务器就是使用日志来记录服务状态变更和撮合成功的信息</p>
<p>参考：</p>
<p><a href="https://stackoverflow.com/questions/11232230/logging-to-two-files-with-different-settings" target="_blank" rel="external">stackoverflow</a></p>
<p><a href="https://www.cnblogs.com/dkblog/archive/2011/08/26/2155018.html" target="_blank" rel="external">logging入门</a></p>
<h3 id="股票平均价格计算"><a href="#股票平均价格计算" class="headerlink" title="股票平均价格计算"></a>股票平均价格计算</h3><p>之前一直没搞清楚怎么算摊薄的成本价，然后搞了下搞懂了，主要是三个公式：</p>
<ol>
<li><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/6734350.jpg" alt=""></li>
<li><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/92869933.jpg" alt=""></li>
<li><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/87577138.jpg" alt=""></li>
</ol>
<p>假设现在有同一股票的3笔交易，规则手续费和税费都按0.1%即0.001收，买入只收手续费，不满5元收足5元，卖出收手续费（规则与买入一样）和税费：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(1) 5.5￥/2000股/买入；总值=11000；手续费=11000*0.1%=11；平均每股成本(后面均称为‘均价’)用公式1算得=5.50</div><div class="line">(2) 5.6￥/300股/买入；总值=1680；手续费=5；均价用公式2算得=5.52</div><div class="line">(3) 5.4￥/400股/卖出；总值=2160；手续费+税费=5+2.16=7.16；均价用公式3算得=5.54</div></pre></td></tr></table></figure>
<p>参考：</p>
<p><a href="https://zhidao.baidu.com/question/689056989138581724.html" target="_blank" rel="external">知道</a></p>
<p>雪球模拟盈亏</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/logging/">logging</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-multiprocessingexp"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/12/09/multiprocessingexp/">多进程服务器折腾、实现</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/12/09/multiprocessingexp/" class="article-date">
	  <time datetime="2017-12-09T12:25:33.000Z" itemprop="datePublished">2017-12-09</time>
	</a>

      
    <a class="article-category-link" href="/categories/to-Quant/">to Quant</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近为了写个回测平台真的累成狗，项目地址<a href="https://github.com/Hochikong/TradeServer" target="_blank" rel="external">TradeServer</a>， 目前实现了下单买入卖出、撤单、查看未成交订单、查看用户信息和余额、查看完整操作记录，查看交易记录和收益统计等功能。主要结构为Flask实现的RESTful API和一个包含三个进程的服务器。Flask那个不难，就是设计好json请求结构然后根据情况返回合适的结果即可，但是另外一个含三个进程的服务器就有点麻烦了。</p>
<h3 id="坑1"><a href="#坑1" class="headerlink" title="坑1"></a>坑1</h3><p>众所周知，Python的多线程是鸡肋，我之前的<a href="https://github.com/Hochikong/SoraScraper" target="_blank" rel="external">爬虫服务器</a>用了rpyc做服务器主体，爬虫函数用了concurrent.futures的ThreadPoolExecutor，本来我是想用多进程实现的，但是发现rpyc做服务主体下你就再也没法用multiprocessing的Pool来执行任务了。现在我的交易服务器需要实现撮合订单或者等待机会撮合，需要多个进程协同操作。</p>
<p>首先是一个进程负责检查数据库某个键的值，如果设置为run，则开始撮合订单，如果设置为stop或其他不是run的值，就会sleep一定的时间然后再检查。那么假设我这个进程能查到这个数据库的键的值为run那么怎样才能让其他进程知道这个消息呢？一般来说最好是使用actor模型，基于消息传递，比如multiprocessing的Queue模块，但是这个交易服务器并不需要那么麻烦，只要一个共享内存就行了。在multiprocessing里可以用Array或者Value来在程序中设置一个进程间都能读写的变量，关于Value或者Array的文档可以看<a href="https://docs.python.org/3.6/library/multiprocessing.html" target="_blank" rel="external">这里</a>，17.2.2.6部分，实现上好像是基于ctypes的共享内存，还有个更高级的Manager，能提供更多数据类型。</p>
<p>这里给一段代码简单地展示下Array的用法pattern：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">from multiprocessing import Process</div><div class="line">from multiprocessing.sharedctypes import Array</div><div class="line">import time</div><div class="line"></div><div class="line">def f():</div><div class="line">    while True:</div><div class="line">        time.sleep(2)</div><div class="line">        print(time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime()))</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    num = Array(&apos;c&apos;, b&apos;hello world&apos;)</div><div class="line"></div><div class="line">    p = Process(target=f, args=())</div><div class="line">    p.start()</div><div class="line">    p.join()</div><div class="line"></div><div class="line">    print(bytes.decode(num.value))</div></pre></td></tr></table></figure>
<p>上面的例子里，首先要从multiprocessing.sharedctypes导入相应的模块，然后创建一个共享变量num，第一个参数是数值类型。上面的例子是char，可以存一定长度的字符类型，即bytes，在python3里可以通过str的encode来把str转换为bytes，也可以用bytes的decode转换为str类型，然后我们就可以把经过encode的字符串放在Array的第二个参数里，如果其他进程想查看这个共享变量的值，直接用num.value就可以获取bytes的值，再转为字符串就不难了。</p>
<p>下面是Array的输入类型对照表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&apos;c&apos;: ctypes.c_char,  &apos;u&apos;: ctypes.c_wchar,</div><div class="line">&apos;b&apos;: ctypes.c_byte,  &apos;B&apos;: ctypes.c_ubyte,</div><div class="line">&apos;h&apos;: ctypes.c_short, &apos;H&apos;: ctypes.c_ushort,</div><div class="line">&apos;i&apos;: ctypes.c_int,   &apos;I&apos;: ctypes.c_uint,</div><div class="line">&apos;l&apos;: ctypes.c_long,  &apos;L&apos;: ctypes.c_ulong,</div><div class="line">&apos;f&apos;: ctypes.c_float, &apos;d&apos;: ctypes.c_double</div></pre></td></tr></table></figure>
<p>总之记住普通的全局变量是无法在进程间共享的。</p>
<h3 id="坑2"><a href="#坑2" class="headerlink" title="坑2"></a>坑2</h3><p>解决了共享内存的问题之后，然后是循环任务的问题。一个撮合服务器，应该每隔一段时间获取用户提交的交易请求，然后根据股票现价等信息进行判定是否能交易。我需要引入另外两个进程，一个用来检查订单然后看能不能交易，另一个用来进行损益统计。我相信很多人查multiprocessing的代码范例都是这种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from multiprocessing import Process</div><div class="line">import os</div><div class="line"></div><div class="line"># 子进程要执行的代码</div><div class="line">def run_proc(name):</div><div class="line">    print &apos;Run child process %s (%s)...&apos; % (name, os.getpid())</div><div class="line"></div><div class="line">if __name__==&apos;__main__&apos;:</div><div class="line">    print &apos;Parent process %s.&apos; % os.getpid()</div><div class="line">    p = Process(target=run_proc, args=(&apos;test&apos;,))</div><div class="line">    print &apos;Process will start.&apos;</div><div class="line">    p.start()</div><div class="line">    p.join()</div><div class="line">    print &apos;Process end.&apos;</div></pre></td></tr></table></figure>
<p>一看似乎没问题，然而这个程序就是执行一次的，既然要反复检查订单是否能成交就要while循环啊，那么这个while要放在哪？</p>
<p>放在main后面？不行的，如果使用Process来实现多进程，下面的代码pattern是不太好的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">	while True:</div><div class="line">		p = Process(xxx)</div><div class="line">		p.start()</div><div class="line">		p.join()</div></pre></td></tr></table></figure>
<p>这种pattern是不行，会提示你创建了多个进程引起冲突：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">	p = Process(xxx)</div><div class="line">	while True:</div><div class="line">		p.start()</div><div class="line">		p.join()</div><div class="line">		</div><div class="line">		</div><div class="line">WARNING:AssertionError: cannot start a process twice</div></pre></td></tr></table></figure>
<p>这个代码意味着你每次循环都创建Process对象然后执行，那么你干嘛不用rpyc写个rpc服务器然后写个普通的while循环的代码来发送请求？</p>
<p>我目前找到的比较ok的多进程服务器代码pattern还是前面的Array例子那个，把while循环放在函数里，main后面就创建Process对象，start()之后这个进程就会一直执行函数里的while循环来打印此刻的时间</p>
<p>下面的pattern在我的撮合服务器代码里也用到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def func():</div><div class="line">	while True:</div><div class="line">		exec xxx</div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">	p = Process(target=func,args=(xxx,xxx))</div><div class="line">	p.start()</div><div class="line">	p.join</div></pre></td></tr></table></figure>
<p>不过要注意的是，函数里的while循环最好加上time.sleep()，不然你的的CPU使用率很快就会急剧上升，至少不加sleep我的笔记本CPU风扇没多久就疯转。</p>
<p>有兴趣的可以深入阅读下我的TradeServer的omserver.py代码。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>并发、并行是个不简单的话题，不过找到合适的代码pattern就很容易写了。还有，还在用py2的，尽可能还是迁移到3.x吧，至少我现在是用python 3.6了。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://docs.python.org/3.6/library/multiprocessing.html" target="_blank" rel="external">官方参考文档</a></p>
<p><a href="https://docs.lvrui.io/2016/07/24/Python%E4%B8%AD%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB/" target="_blank" rel="external">多进程数据共享（好文）</a></p>
<p><a href="http://xiaorui.cc/2016/05/10/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90multiprocessing%E7%9A%84value-array%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%8E%9F%E7%90%86/" target="_blank" rel="external">共享内存实现原理</a></p>
<p><a href="https://my.oschina.net/leejun2005/blog/203148" target="_blank" rel="external">如何共享变量（很老的文章）</a></p>
<p><a href="http://blog.csdn.net/q_l_s/article/details/53339473" target="_blank" rel="external">别人的学习笔记</a></p>
<p><a href="https://www.cnblogs.com/kaituorensheng/p/4445418.html" target="_blank" rel="external">多进程编程</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multiprocessing/">multiprocessing</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-hypervonwinten"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/11/22/hypervonwinten/">Win10 Hyper-V虚拟机折腾记录</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/11/22/hypervonwinten/" class="article-date">
	  <time datetime="2017-11-22T07:21:58.000Z" itemprop="datePublished">2017-11-22</time>
	</a>

      
    <a class="article-category-link" href="/categories/日常折腾/">日常折腾</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>本来我还是在用win7，但是越来越觉得不接收微软的安全更新简直就是要命，然后也想顺便清理下工作环境重新安装一些东西clean下，于是昨天通宵搞启动盘重装系统。装了win10 pro用Microsoft Toolkit激活了。然后安装了Docker for Windows，安装这个会自动帮我配置增加hyper-v的功能。配置完毕之后，如果你启动docker就会启用一个vswitch。这里的vswitch类似VMware的adapter。</p>
<h1 id="配置一个能与宿主机互ping的虚拟机全流程"><a href="#配置一个能与宿主机互ping的虚拟机全流程" class="headerlink" title="配置一个能与宿主机互ping的虚拟机全流程"></a>配置一个能与宿主机互ping的虚拟机全流程</h1><ol>
<li><p>创建一个新vswitch</p>
</li>
<li><p>修改现有的网络适配器，为刚才创建的vswitch提供共享</p>
</li>
<li><p>配置防火墙的入站规则</p>
<p>​</p>
</li>
</ol>
<p>下面就具体讲讲是怎么做的</p>
<h2 id="1-创建vswitch"><a href="#1-创建vswitch" class="headerlink" title="1.创建vswitch"></a>1.创建vswitch</h2><p>打开Hyper-V管理器，选择“虚拟交换机管理器”：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/5311209.jpg" alt=""></p>
<p>然后创建一个新的“内部网络”虚拟交换机，随便命名即可，我先前创的是VS NAT：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/14450408.jpg" alt=""></p>
<h2 id="2-修改网络接口"><a href="#2-修改网络接口" class="headerlink" title="2.修改网络接口"></a>2.修改网络接口</h2><p>创建完这个之后，就去控制面目板的“网络连接”选择你现在用的Internet适配器：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/81462811.jpg" alt=""></p>
<p>右键选择“属性”然后切换到“共享”的页面，允许你刚才创建的vswitch访问：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/14144087.jpg" alt=""></p>
<p>这样一来就完成了基本配置，这时候点开你创建的vswitch找IPv4属性，可以看到分配的IP地址和掩码：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/39926489.jpg" alt=""></p>
<h2 id="3-修改防火墙规则"><a href="#3-修改防火墙规则" class="headerlink" title="3.修改防火墙规则"></a>3.修改防火墙规则</h2><p>在做了上面的配置之后，使用你刚才创建的NAT vswitch的虚拟机都已经能上网，宿主机也能ping通虚拟机，但是虚拟机无法ping宿主，这就需要你启用下面的防火墙入站规则：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/77013435.jpg" alt=""></p>
<p>然后也可以自定配置一个规则，允许来自虚拟机对宿主的任何访问：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/98311745.jpg" alt=""></p>
<p>配置就到此为止，虚拟机和宿主能互ping且虚拟机也能上网了</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.cnblogs.com/staneee/p/6879842.html" target="_blank" rel="external">Ping不通的解决方法</a></p>
<p><a href="http://blog.csdn.net/rrrfff/article/details/51168376" target="_blank" rel="external">配置NAT</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Hyper-V体验还不错，不过如果不是因为要跑docker on windows我也不会装这个东西，还是使用VMware。</p>
<h1 id="11-23更新"><a href="#11-23更新" class="headerlink" title="11/23更新"></a>11/23更新</h1><p>放弃了hyper-v和docker on windows，还是用回vmware吧</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hyper-V/">Hyper-V</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-headlessfirefox"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/11/21/headlessfirefox/">StockClib开发小结</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/11/21/headlessfirefox/" class="article-date">
	  <time datetime="2017-11-20T18:10:19.000Z" itemprop="datePublished">2017-11-21</time>
	</a>

      
    <a class="article-category-link" href="/categories/to-Quant/">to Quant</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="StockClib更新之际"><a href="#StockClib更新之际" class="headerlink" title="StockClib更新之际"></a>StockClib更新之际</h1><p>上个周末花了点时间更新了我的StockClib项目，增加了对富途牛牛网页模拟账户交易操作的功能，同时StockClib更新到0.2。本文将会总结下开发途中的一些问题。</p>
<h1 id="曲线救国"><a href="#曲线救国" class="headerlink" title="曲线救国"></a>曲线救国</h1><p>一开始我考虑用的量化平台是BotVS，但是BotVS有两点很难忍：  </p>
<ol>
<li>文档混乱，看得一脸懵逼  </li>
<li>无法支持第三方库，意味着策略无法与外界交换数据  </li>
</ol>
<p>后面我换了聚宽，聚宽的教程和文档和ricequant的都差不多也很清晰，聚宽还支持用requests来交换数据，但是问题又出现了，我要加密传输交易信号才行，本来问了朋友考虑用AES加密但是后面实际玩了下，聚宽的策略运行必须先回测，但我那套策略思路要搞回测很困难，而且回测的意义不大，因此决定放弃一切量化平台（虽然前期学习必须在那些平台上练手），自己做交易接口，不做回测了。</p>
<p>万得终端有套支持excel、matlab和python等语言的本地交易API，但是文档像吃了屎一样，富途牛牛之类的客户端无法控制意义也不大。遂找网页版的模拟交易账户，一开始是找了同花顺的，但是太简陋，没用。后来看了下新浪爱财iTrade，也不算满意，最后找到了富途牛牛模拟交易的网页版入口，用手机注册即可。最重要的是一个网页同时支持A、H和美股的交易，可玩性就强了很多了。</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/67369473.jpg" alt=""></p>
<p>这么看来，以后要是实际跑策略实盘，估计直接用浏览器自动操作就可以了。前提是券商提供网页版下单入口。  </p>
<h1 id="分析研究"><a href="#分析研究" class="headerlink" title="分析研究"></a>分析研究</h1><p>通过firefox抓包，我发现了富途牛牛网页交易时发送的数据结构，但是cookie有些内容搞不明白怎么生成的，于是选择了headless浏览器+splinter的方案</p>
<p>在windows上直接用firefox测试，基本把登录、下单的测试代码弄出来了（下面是部分测试实例）：</p>
<pre><code>In [31]: f = b.find_by_name(&apos;stockCode&apos;)

In [32]: f
Out[32]:
[&lt;splinter.driver.webdriver.WebDriverElement at 0x6d546a0&gt;,
 &lt;splinter.driver.webdriver.WebDriverElement at 0x6d54128&gt;]

In [33]: f[1].fill(&quot;000858&quot;)

In [34]:

In [34]: g = b.find_by_name(&quot;price&quot;)

In [35]: g
Out[35]: [&lt;splinter.driver.webdriver.WebDriverElement at 0x6a25780&gt;]

In [36]: g[0].fill(76.20)

In [45]: amount = b.find_by_name(&quot;qty_str&quot;)

In [46]: amount
Out[46]: [&lt;splinter.driver.webdriver.WebDriverElement at 0x6a22320&gt;]

In [47]: amount[0].fill(&quot;400&quot;)

In [48]: buy = b.find_by_text(&quot;模拟买入&quot;)

In [49]: buy
Out[49]: [&lt;splinter.driver.webdriver.WebDriverElement at 0x69fa358&gt;]

In [50]: buy[0].click()

In [52]: bid
Out[52]: [&lt;splinter.driver.webdriver.WebDriverElement at 0x69361d0&gt;]

In [53]: bid[0].click()

In [54]: confirm = b.find_by_text(&quot;确定&quot;)

In [55]: confirm
Out[55]:
[&lt;splinter.driver.webdriver.WebDriverElement at 0x6a2d7b8&gt;,
 &lt;splinter.driver.webdriver.WebDriverElement at 0x6a2d160&gt;]

confirm[1].click()
</code></pre><p>但是存在一个问题，无法指定撤单，只能先撤最新的单：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/53010563.jpg" alt=""></p>
<p>问题存在的原因主要是splinter不支持根据class找元素，而我那时候还没搞懂xpath，结果就放弃了基于splinter的代码（实际上只要用xpath，没有任何元素是找不到的）</p>
<p>我的splinter的初步方案是使用click_link_by_text(“撤单”)来做撤单，但是这个就无法撤前面的单，只能撤了最新的单再撤旧单。</p>
<p>后面基于“根据class找元素”的想法，选择了selenium，这个库是splinter的底层，splinter只是简化了使用（也相当于减少了部分功能），后面不知咋的找到了xpath的资料翻了下，发现提取xpath简单到死，直接对着元素选择检查然后右键复制xpath即可，不过chrome和firefox的xpath格式不同，前者的往往是很简短的，比如：</p>
<pre><code>//*[@id=&apos;confirmDialog&apos;]/div[3]/span[2]/button[2]
</code></pre><p>即使格式不同，但是都能被selenium正确识别。</p>
<p>最后撤单逻辑通过位置来确定不同的单，然后输入一个从1数起的坐标即可选择性撤单，最新的单位置为1，旧的单位置值递增，比如上图特锐德的位置是1，中车的位置是2，只要输入准确的位置就可以撤单，但是要时刻维护一个“待成交单”的数据，不然无法撤单。</p>
<p>因此我在StockClib里增加了ftTrader库，一个无状态的基于firefox的自动交易接口库，预计0.3会增加一个函数简化交易数据的维护，而0.4开始会逐渐增加对美股港股的支持。</p>
<p>不过有点小问题，虽然我已经显式给selenium加了waits，但是如果网络不好，网页加载未完的话就执行交易函数的话会出现下单失败的问题，这个后面0.3会尝试修复。</p>
<h1 id="headless"><a href="#headless" class="headerlink" title="headless"></a>headless</h1><p>我一开始想用chromeless，但是不支持python，弃。然后找headless chrome，无奈我windows的chrome是58，windows版要60才支持headless模式。后来在虚拟机里测试，但是selenium总是启动不了headless chrome，报错，而且安装贼麻烦，最后直接换headless firefox了。如果ftTrader选择debug模式，则会启动GUI版火狐，否则默认headless。headless模式下必须指定geckodriver的路径才能正常启动，刚好我的火狐更新到了57，Windows版可以测试headless模式，而linux下安装也不麻烦，apt就一句命令的事。FF最新版对比旧版的确快不少，体验较好。</p>
<p>关于headless firefox的资料可以看这里：<a href="https://developer.mozilla.org/en-US/Firefox/Headless_mode" target="_blank" rel="external">Here</a>  </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>完成这个交易API之后就可以着手搞策略和对应的策略执行引擎了，当然我也不希望又搞套DSL出来，策略直接是python程序就好，托管者就像supervisor一样监控运行状态就够了。不过在搞这些之前，我还是得看看传统的量化知识。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://selenium-python.readthedocs.io/waits.html" target="_blank" rel="external">Selenium的Waits</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Firefox/">Firefox</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-regintro"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/10/29/regintro/">正则表达式快速入门参考</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/10/29/regintro/" class="article-date">
	  <time datetime="2017-10-29T13:46:42.000Z" itemprop="datePublished">2017-10-29</time>
	</a>

      
    <a class="article-category-link" href="/categories/to-Quant/">to Quant</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>虽然在为VyOS写python-vyos-mgmt的时候已经被提醒过一定要学正则表达式，不过一直没空去学，然后今天准备去看看BotVS的资料的时候就看到有则关于正则的资料，遂趁开例会时的空闲时间快速入门了一把。虽然用bash的时候经常用*来rm，但是更复杂的基本不会用了。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>这个cheat sheet包含了绝大多数的使用方式：</p>
<p><img src="http://blogpics5437.oss-cn-shenzhen.aliyuncs.com/18-8-13/41946206.jpg" alt="">  </p>
<p>更详细的文档可以参考这里：</p>
<p><a href="http://www.cnblogs.com/huxi/archive/2010/07/04/1771073.html" target="_blank" rel="external">cheatsheet</a>   </p>
<p>然后为了方便测试自己的正则表达式是否正确，推荐一个国人编写的运行在.Net的图形化工具Regester，最后更新在2017年6月:</p>
<p><a href="http://deerchao.net/tools/regester/index.htm" target="_blank" rel="external">Regester</a>  </p>
<p>他也推出了一个30分钟入门教程（虽然可能不止30分钟）：</p>
<p><a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="external">30分钟入门</a>  </p>
<p>不过我觉得如果不借助任何工具去学的话还是这个人的教程比较适合，他把能匹配的字符串都按代码格式显示方便理解：</p>
<p><a href="http://www.jianshu.com/p/ac2596be9606" target="_blank" rel="external">入门</a>  </p>
<p><a href="http://www.jianshu.com/p/555f85023a7f" target="_blank" rel="external">进阶</a></p>
<h1 id="我觉得比较重要的内容"><a href="#我觉得比较重要的内容" class="headerlink" title="我觉得比较重要的内容"></a>我觉得比较重要的内容</h1><ol>
<li><p>一个”.”只能匹配一个字符，N个”.”能匹配N个</p>
</li>
<li><p>“\”各领域都很常见的转义字符</p>
</li>
<li><p>“K[abc]T”只能匹配一个长度为3的，含abc任意“一个”字符的字符串，”KabT”无法被匹配，而使用这个模式可以匹配”KabT”：K[\w]*T</p>
</li>
<li><p>“{m}”匹配前一个字符串m次，比如”a{2}b”，如果目标字符串为”aaab”,则只能匹配出”aab”，若目标为”ab”，则无法匹配</p>
</li>
<li><p>“{m,n}”中，m&lt;n</p>
</li>
<li><p>“[A-Za-z0-9]”匹配任何字母和数字，”\w”则匹配[A-Za-z0-9_]（多一个下划线），”\s”是空白字符，大写”\w”和”\s”的规则都是原来的字符的对立规则 </p>
</li>
<li><p>后面加问号，比如”*?”可将匹配符变成非贪婪的</p>
</li>
<li><p>“^”在中括号内为否定，中括号/字符串外为头部边界，”$”则用作尾部边界</p>
</li>
</ol>
<h1 id="Python的re模块的通用代码patten"><a href="#Python的re模块的通用代码patten" class="headerlink" title="Python的re模块的通用代码patten"></a>Python的re模块的通用代码patten</h1><pre><code>import re
pattern = re.compile(&quot;K[\w]*T&quot;)
# 无法匹配时将返回None
res = pattern.match(&quot;K[\w]*T&quot;)
if res:print(res.group())
</code></pre><p>结果：</p>
<pre><code>In [10]: if res:print(res.group())
KabvT
</code></pre><p>如果匹配失败：</p>
<pre><code>In [6]: res = pattern.match(&quot;K T&quot;)

In [7]: res.group()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
&lt;ipython-input-7-09a435ad28f6&gt; in &lt;module&gt;()
----&gt; 1 res.group()
</code></pre><h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>和Vi一样我也不能完全记住全部快捷键，正则还是用到再具体看吧</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/正则表达式/">正则表达式</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2019 HOCHIKONG&#39;s WAPORIZer All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="https://ckho.top" class="mobile-nav-link">Service</a>
  
    <a href="http://h2q.weebly.com" class="mobile-nav-link">Works</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>










	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            HOCHIKONG&#39;s WAPORIZer
          </div>
          <div class="panel-body">
            Copyright © 2019 Hochikong All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
</body>
</html>